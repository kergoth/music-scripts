#!/bin/sh
# TODO: add option to separate discs to separate folders, and remember to
# include disc subtitle if set

. "$(dirname "$0")/common-music.sh"
. "$(dirname "$0")/trap.sh"

case "$BASH_VERSION" in
    '')
        trap 'rm -f $cleanfiles; on_exit' EXIT
        ;;
    *)
        trap 'rm -f $cleanfiles' EXIT
        ;;
esac
# trap 'rm -f $cleanfiles' EXIT

PATH="$(cd "$(dirname "$0")" && pwd):$PATH"

set -e

usage() {
    cat >&2 <<END
${0##*/} [options] SOURCE_DIR [SOURCE_DIR..]

Options:
    -n    Dry run
    -d    Separate discs into their own folders
END
    exit 2
}


alias link='ln -fv'

if [ $# -eq 0 ]; then
    set -- .
fi

dry_run=0
separate_discs=0
while getopts ndh opt; do
    case "$opt" in
        n)
            dry_run=1
            ;;
        d)
            separate_discs=1
            ;;
        \? | h)
            usage
            ;;
    esac
done
shift $((OPTIND - 1))

if [ $# -eq 0 ]; then
    usage
fi

audiofiles="$(mktemp -t "${0##*/}.XXXXXX")" || exit 1
otherfiles="$(mktemp -t "${0##*/}.XXXXXX")" || exit 1
cleanfiles="$audiofiles"
trap 'rm -f "$audiofiles"' INT TERM

preparebar() {
# $1 - bar length
# $2 - bar char
    barlen=$1
    barspaces=$(printf "%*s" "$1")
    barchars=$(printf "%*s" "$1" | tr ' ' "$2")
}

progressbar() {
# $1 - number (-1 for clearing the bar)
# $2 - max number
    if [ $1 -eq -1 ]; then
        printf "\r  $barspaces\r"
    else
        barch=$(($1*barlen/$2))
        barsp=$((barlen-barch))
        printf "\r${3:+$3 }[%.${barch}s%.${barsp}s] ${4:+ $4}$barspaces\r" "$barchars" "$barspaces"
    fi
}

preparebar 40 "â–‡"
for source_dir; do
    if [ ! -e "$source_dir" ]; then
        continue
    fi
    source_dir="${source_dir%/}"
    music_find "$source_dir" >"$audiofiles"
    filecount=$(wc -l <"$audiofiles" | xargs)
    curcount=0
    progressbar -1 "$filecount" "${source_dir##*/}" "$curcount/$filecount    "
    while read -r fn; do
        curcount=$((curcount + 1))
        progressbar $curcount "$filecount" "${source_dir##*/}" "$curcount/$filecount    "
        newfn="$(get_new_filename ${separate_discs+-d} "$fn" "$source_dir")"
        if [ "$fn" != "$newfn" ] && ! [ -e "$newfn" ]; then
            newfndir="$(dirname "$newfn")"
            if [ $dry_run -eq 0 ]; then
                mkdir -p "$newfndir"
            fi

            if [ $dry_run -eq 1 ]; then
                echo "$fn -> $newfn"
            else
                mv -v "$fn" "$newfn"
            fi

            oldfndir="$(dirname "$fn")"
            if ! echo "$oldfndir" | grep -qix "$newfndir"; then
                # Non-audio files
                nonmusic_find "$oldfndir" \
                    | while read -r efn; do
                        newefn="$newfndir/${efn##*/}"
                        if ! grep -qx "$efn" "$otherfiles" && ! [ -e "$newefn" ]; then
                            echo "$efn" >>"$otherfiles"
                            if [ $dry_run -eq 1 ]; then
                                echo "$efn -> $newefn"
                            else
                                mv -v "$efn" "$newefn"
                            fi
                        fi
                    done
            fi
        fi
    done <"$audiofiles"
    remove-empty-dirs "$source_dir" >/dev/null 2>&1
    echo
done
